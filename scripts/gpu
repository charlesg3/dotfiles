#!/usr/bin/env bash
# git push, automatically setting upstream if not set.

OUTPUT=$(git push 2>&1)
STATUS=$?

if [[ $STATUS -eq 0 ]]; then
    echo "$OUTPUT"
    exit 0
fi

if echo "$OUTPUT" | grep -q "has no upstream branch"; then
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    git push --set-upstream origin "$BRANCH"
else
    echo "$OUTPUT" >&2
    exit $STATUS
fi
