#!/bin/bash

# If not running interactively, don't do anything
[ -z "$PS1" ] && return

_ble=/usr/share/blesh/ble.sh
[[ -f "$HOME/.local/share/blesh/ble.sh" ]] && _ble="$HOME/.local/share/blesh/ble.sh"
[[ -f "$_ble" ]] && source "$_ble" --noattach; unset _ble

export PATH="$HOME/.local/bin:$HOME/src/dotfiles/scripts:$PATH"

alias tmux='tmux -2'

export TERM=xterm-256color
export HISTCONTROL=ignoredups

unset JAVA_TOOL_OPTIONS

ulimit -c unlimited

shopt -s checkwinsize

# enable color support of ls
if [ "$TERM" != "dumb" ]; then
    eval "$(dircolors -b)"
    alias ls='ls --color=auto'
fi

# BASH_SOURCE resolves to this file; walk up bash/ -> dotfiles/
_dotfiles="$(dirname "$(realpath "${BASH_SOURCE[0]}")")/.."
source "$_dotfiles/shell/colors.sh"
source "$_dotfiles/shell/aliases.sh"
unset _dotfiles

# make less more friendly for non-text input files
[ -x /usr/bin/lesspipe ] && eval "$(lesspipe)"

# set terminal title to user@host:dir
case "$TERM" in
xterm*|rxvt*|vt102|screen*)
    PROMPT_COMMAND='echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD}\007"'
    export PROMPT_COMMAND
    ;;
esac

# set variable identifying the chroot you work in
if [ -z "$debian_chroot" ] && [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

# colorful prompt (colors defined in shell/colors.sh, sourced above)
case "$TERM" in
xterm*|rxvt*|screen*|vt102)
    PS1='${debian_chroot:+($debian_chroot)}$([ $? -eq 0 ] && echo "${_PS_PROMPT_OK}▸${_PS_RESET}" || echo "${_PS_PROMPT_ERR}▸${_PS_RESET}")${_PS_PROMPT_USER}\u${_PS_PROMPT_SEP}@${_PS_PROMPT_HOST}\h${_PS_RESET}:${_PS_PROMPT_DIR}\w${_PS_PROMPT_DOLLAR}\$${_PS_RESET} '
    ;;
*)
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w→ '
    ;;
esac

PS2='$'

# bash completion
if [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
elif [ "$(uname)" = "Darwin" ] && [ -r "$(brew --prefix 2>/dev/null)/etc/profile.d/bash_completion.sh" ]; then
    . "$(brew --prefix)/etc/profile.d/bash_completion.sh"
fi

# ── Local overrides (machine-specific, not tracked) ──────────────────────────
[ -f "$HOME/.bashrc.local" ] && . "$HOME/.bashrc.local"

[[ ${BLE_VERSION-} ]] && ble-attach

# ── Kitty shell integration ───────────────────────────────────────────────────
# $KITTY_INSTALLATION_DIR is set by Kitty at launch; no-op outside Kitty
# Must come after ble-attach since both use the DEBUG trap
[ -n "$KITTY_INSTALLATION_DIR" ] && \
    source "$KITTY_INSTALLATION_DIR/shell-integration/bash/kitty.bash"

# ── Long-command bell (shows green dot in kitty tab) ─────────────────────────
_long_cmd_start=
_long_cmd_check() {
    if [[ -n "$_long_cmd_start" ]] && (( SECONDS - _long_cmd_start >= 10 )); then
        printf '\a'
    fi
    _long_cmd_start=$SECONDS
}
PROMPT_COMMAND="${PROMPT_COMMAND:+$PROMPT_COMMAND; }_long_cmd_check"
